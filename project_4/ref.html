<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project 4</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.1.9/p5.js"></script>
    <script>

        // let generalSsrValueURL = "https://api.particle.io/v1/devices/e00fce68382d1061af2a22a7/general_ssr_value?access_token=0930f13c270866353de281747e0789101d21e4a7";

        var gs = 21,
            wp, q; //Variables for grid!
        var M = 'Male',
            F = 'Female',
            am = 0,
            man = []; //Variables for 'Man'
        var y = 0,
            d = 0,
            dy = 10,
            fps = 0,
            ms = 0,
            noLag = false;
            tp = 0,
            l = 0,
            clan_a = 1,
            kills = 0,
            starv = 0; //overall
        var ts = 15,
            ds = 20,
            timer = 0,
            ss, fr = 10;
        var grw, st = 30,
            sid = 0;
        var f = 0,
            m = 0,
            ft = 0,
            mt = 0,
            fa = [],
            ma = [],
            sp_ = 1;

        var allow_death = false,
            maok = 20,
            maxp = 500,
            maxClan = 10; //<<<<-----------------
        //                   Max Kids - maxPopulation

        function setup() {
            ss = second();
            createCanvas(1920, 899);
            if (width > height) {
                q = height;
            } else {
                q = width;
            }
            grw = width / 8.8;

            strokeJoin(ROUND);

            wp = round(q / gs);
            man[0] = new Man(0, 0, [0, 0], M, 0);
            man[1] = new Man(10, 0, [0, 0], F, 0);
            man[2] = new Man(40, 10, [0, 0], M, 1);
            man[3] = new Man(60, 50, [0, 0], F, 1);
            man[4] = new Man(30, 100, [0, 0], M, 2);
            man[5] = new Man(10, 30, [0, 0], F, 2);
            man[6] = new Man(30, 100, [0, 0], M, 3);
            man[7] = new Man(10, 30, [0, 0], F, 3);
            man[8] = new Man(30, 100, [0, 0], M, 4);
            man[9] = new Man(10, 30, [0, 0], F, 4);
            man[10] = new Man(30, 100, [0, 0], M, 5);
            man[11] = new Man(10, 30, [0, 0], F, 5);
            man[12] = new Man(30, 100, [0, 0], M, 6);
            man[13] = new Man(10, 30, [0, 0], F, 6);
            man[14] = new Man(30, 100, [0, 0], M, 7);
            man[15] = new Man(10, 30, [0, 0], F, 7);

            document.oncontextmenu = function () {
                noLag = !noLag;
                return false;
            }
        }

        function draw() {
            sp_ = constrain(sp_, 1, 10);
            for (var qaqa = 0; qaqa < sp_; qaqa++) {
                draw_();
            }
            if (keyIsDown(UP_ARROW)) {
                sp_++;
            }

            if (keyIsDown(DOWN_ARROW)) {
                sp_--;
            }
        }

        function draw_() {
            frameRate(fr);
            if (clan_a == 1) {
                for (var i = 0; i < clan.list.length; i++) {
                    for (var j = 0; j < grw; j++) {
                        clan.list[i].array[j] = 0;
                    }
                }
                for (var j = 0; j < grw; j++) {
                    ma[j] = 0;
                    fa[j] = 0;
                }
                clan_a = 0;
            }
            am = man.length;
            if (ss == second()) {

            } else {
                timer++;
                ss = second();
            }
            ms++;
            d += 2;
            if (d > dy) {
                d = 0;
                y++;
            }
            if (ms > 10) {
                fps = round(frameRate());
                ms = 0;
            }
            background(200, 190, 180);
            strokeWeight(1);
            if (!noLag) {
                makeGrid();
            }
            noStroke();
            for (var i = 0; i < am; i++) {
                push();
                translate(wp, wp);
                man[i].move(round(random(-1, 1)), round(random(-1, 1)));
                man[i].warp(0, 0, q - (wp * 2), q - (wp * 2));
                man[i].show(i);
                pop();
                if (d == man[i].bd[0]) {
                    man[i].age++;
                }
                if (man[i].age > 75 & allow_death == true) {
                    man[i].power -= random(0, 0.5);
                    if (man[i].power < 0) {
                        man[i].clan.amount--;
                        if (man[i].gender == M) {
                            m--;
                        } else {
                            f--;
                        }
                        man.splice(i, 1);
                        am = man.length;
                    }
                }
            }
            if (!noLag) {
                graph();
            }
            for (var i = am - 1; i > 0; i--) {
                for (var j = am - 1; j > 0; j--) {
                    if (i != j) {
                        am = man.length;
                        if (man[i].x == man[j].x & man[i].y == man[j].y & man[i].gender != man[j].gender & man[i].age > 18 & man[j].age > 18 & man[i].maried < maok & man[j].maried < maok) {
                            man[i].maried += 1;
                            man[j].maried += 1;
                            if (man[i].clan == man[j].clan) {
                                if (round(random(1)) == 1) {
                                    man[am] = new Man(man[i].x, man[j].y, [d, y], M, man[i].c);
                                } else {
                                    man[am] = new Man(man[i].x, man[j].y, [d, y], F, man[i].c);
                                }
                                am = man.length;
                            } else {
                                if (round(random(1)) == 1) {
                                    var aa = M;
                                } else {
                                    var aa = F;
                                }
                                if (round(random(2)) == 0) {
                                    if (man[i].clan.power > man[j].clan.power) {
                                        man[am] = new Man(man[i].x, man[j].y, [d, y], aa, man[i].c);
                                    } else if (man[i].clan.power < man[j].clan.power) {
                                        man[am] = new Man(man[i].x, man[j].y, [d, y], aa, man[j].c);
                                    }
                                } else {
                                    if (man[i].c - 1 > clan.list.length) {
                                        addClan(createName(), [random(40, 255), random(40, 255), random(40, 255)], round(random(clan.list[clan.list.length - 1].power - 5, clan.list[clan.list.length - 1].power + 1)));
                                        man[am] = new Man(man[i].x, man[j].y, [d, y], aa, man[i].c + 1);
                                    } else {
                                        if (round(random(3)) == 0) {
                                            man[am] = new Man(man[i].x, man[j].y, [d, y], aa, man[i].c + 1);
                                        } else {
                                            man[am] = new Man(man[i].x, man[j].y, [d, y], aa, man[i].c);
                                        }
                                    }
                                }
                                am = man.length;
                            }
                            if (man[i].x == man[j].x & man[i].y == man[j].y) {
                                if (man[i].clan.enemy.includes(man[j].c) | man[j].clan.enemy.includes(man[i].c)) {
                                    if (man[i].clan.power > man[j].clan.power) {
                                        man[j].clan.amount--;
                                        kills++;
                                        if (man[i].gender == M) {
                                            m--;
                                        } else {
                                            f--;
                                        }
                                        man.splice(j, 1);
                                        am = man.length;
                                    } else if (man[i].clan.power < man[j].clan.power) {
                                        man[i].clan.amount--;
                                        kills++;
                                        if (man[i].gender == M) {
                                            m--;
                                        } else {
                                            f--;
                                        }
                                        man.splice(i, 1);
                                        am = man.length;
                                    } else if (man[i].clan.power == man[j].clan.power) {
                                        var ii = round(random(1, 3));
                                        if (ii == 1) {
                                            man[i].clan.amount--;
                                            kills++;
                                            if (man[i].gender == M) {
                                                m--;
                                            } else {
                                                f--;
                                            }
                                            man.splice(i, 1);
                                            am = man.length;
                                        } else if (ii == 2) {
                                            man[j].clan.amount--;
                                            kills++;
                                            if (man[i].gender == M) {
                                                m--;
                                            } else {
                                                f--;
                                            }
                                            man.splice(j, 1);
                                            am = man.length;
                                        } else if (ii == 3) {

                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            for (var i = 0; i < clan.list.length; i++) {
                clan.list[i].array[clan.list[i].array.length] = clan.list[i].amount;
                clan.list[i].array.splice(0, 1)
                if (clan.list[i].amount == 0) {
                    clan.list.splice(i, 1);
                }
            }
            if (am >= maxp) {
                var j = -(maxp - am);
                for (var i = 0; i < j * 2; i++) {
                    man[i].clan.amount--;
                    if (man[i].gender == M) {
                        m--;
                    } else {
                        f--;
                    }
                    starv++;
                    man.splice(i, 1);
                }
            }
            if (!noLag) {
                debug();
            } else {
                noStroke();
                fill(0);
                text('FRAMERATE : ' + fps + '/' + fr, (width / 2) - (wp / 2), wp + (ts * 3));
            }

            strokeWeight(5);
            noFill();
            rect(wp, wp, q - wp * 2 + (gs / 4), q - wp * 2 + (gs / 4));
            if (am == 0) {
                noLoop();
                stroke(0);
                fill(255, 0, 0);
                strokeWeight(10);
                textSize(50);
                text('DONE', width / 2, height / 2);
            }
            if (clan.list[clan.list.length - 1].amount > maxp / 1.5) {
                addClan(createName(), [random(40, 255), random(40, 255), random(40, 255)], round(random(clan.list[clan.list.length - 1].power - 5, clan.list[clan.list.length - 1].power + 1)));
                if (clan.list[0].amount == 0) {
                    clan.list.splice(0, 1);
                }
            }
            push();
            translate(wp, wp);
            man[sid].show(sid);
            pop();
            ma[ma.length] = m;
            fa[fa.length] = f;
            ma.splice(0, 1);
            fa.splice(0, 1);
            stats(sid);
            if (l == 1) {
                stroke(0);
                fill(0, 100);
                triangle(width / 2 - (width / 20), height / 2 - (height / 20), width / 2 - (width / 20), height / 2 + (height / 20), width / 2 + (width / 15), height / 2);
            }
        }

        function keyReleased() {
            if (keyCode == 32) {
                if (l == 0) {
                    l = 1;
                    noLoop();
                } else {
                    l = 0;
                    loop();
                }
            }
            if (keyCode == 67) {
                am = man.length;
                for (var i = 0; i < round(am / 4); i++) {
                    man[i].clan.amount--;
                    if (man[i].gender == M) {
                        m--;
                    } else {
                        f--;
                    }
                    man.splice(i, 1);
                }
            }
            if (keyCode == 88) {
                if (fr == 10) {
                    fr = 20;
                } else if (fr == 20) {
                    fr = 30;
                } else if (fr == 30) {
                    fr = 40;
                } else if (fr == 40) {
                    fr = 50;
                } else if (fr == 50) {
                    fr = 10;
                }
            }
        }

        function mouseReleased() { //______________________________________________________________________________________________________________
            if (l == 1) {
                for (var i = 0; i < am; i++) {
                    if (mouseX - wp > man[i].x & mouseX - wp < man[i].x + man[i].s & mouseY - wp > man[i].y & mouseY - wp < man[i].y + man[i].s) {
                        sid = i;
                    } else {
                        //sid = i;
                    }
                }
                drawAgain();
                stroke(0);
                fill(0, 100);
                triangle(width / 2 - (width / 20), height / 2 - (height / 20), width / 2 - (width / 20), height / 2 + (height / 20), width / 2 + (width / 15), height / 2);
            }
        }

        function invertColor(i) {
            var j = map(i, 0, 255, 255, 0);
            return j;
        }

        function addClan(n, c, p) {
            var newClan = {
                name: n,
                color: c,
                power: p,
                amount: 0,
                array: [],
                enemy: [round(random(clan.list.length - 1)), round(random(clan.list.length - 1)), round(random(clan.list.length - 1)), round(random(clan.list.length - 1))],
                friend: [round(random(clan.list.length - 1)), round(random(clan.list.length - 1)), round(random(clan.list.length - 1))]
            }
            if (clan.list.length < maxClan) {
                clan.list.push(newClan);
                for (var j = 0; j < grw; j++) {
                    clan.list[clan.list.length - 1].array[j] = 0;
                }
            }
        }

        function drawAgain() {
            background(200, 190, 180);
            strokeWeight(1);
            if (!noLag) {
                makeGrid();
            }
            noStroke();
            am = man.length;
            for (var i = 0; i < am; i++) {
                push();
                translate(wp, wp);
                man[i].show();
                pop();
            }
            if (!noLag) {
                graph();
                debug();
            }
            strokeWeight(5);
            push();
            translate(wp, wp);
            man[sid].show(sid);
            pop();
            stats(sid);
            noFill();
            rect(wp, wp, q - wp * 2 + (gs / 4), q - wp * 2 + (gs / 4));
        }

        function stats(i_) {
            i_ = constrain(i_, 0, man.length - 1);
            //if(1 == 1){
            push();
            translate(width / 2.036, wp + (ts * 11.5));
            fill(200, 200, 200);
            rect(wp / 2.5, wp / 2.5, width / 6, grw / 1.9);
            man[i_].showForce((wp / 2.5) + 10, (wp / 2.5) + 10, st);
            translate((wp / 2.5) + 10, st / 3);
            var sst = st / 2.5;
            textSize(sst);
            fill(0);
            textAlign(LEFT);
            text('Clan : ' + man[i_].clan.name, st * 1.25, sst * 1);
            text('Gender : ' + man[i_].gender, st * 1.25, sst * 2);
            text('Age : ' + man[i_].age, st * 1.25, sst * 3);
            text('Kids : ' + man[i_].maried, st * 1.25, sst * 4);
            pop();
            /*
            }else{
              i_ = 0;
              push();
              translate(width/2.036,wp+(ts*10.5));
              fill(200,200,200);
              rect(wp/2.5,wp/2.5,width/3,grw/1.9);
              man[i_].showForce((wp/2.5)+10,(wp/2.5)+10,st);
              translate((wp/2.5)+10,st/3);
              var sst = st/2.5;
              textSize(sst);
              fill(0);
              textAlign(LEFT);
              text('Clan : ' + man[i_].clan.name,st*1.25,sst*1);
              text('Gender : ' + man[i_].gender,st*1.25,sst*2);
              text('Age : ' + man[i_].age,st*1.25,sst*3);
              text('Kids : ' + man[i_].maried,st*1.25,sst*4);
              pop();
            }
            */
        }

        function makeGrid() {
            for (var i = wp; i < q - wp; i += gs) {
                for (var j = wp; j < q - wp; j += gs) {
                    strokeWeight(2);
                    fill(225);
                    stroke(200);
                    rect(i, j, gs, gs);
                }
            }
        }

        function Man(x, y, date, g, c, year) {
            tp++;
            this.name = round(millis());
            this.x = x;
            this.y = y;
            this.s = gs;
            this.bd = date;
            this.gender = g;
            if (this.gender == M) {
                m++;
                mt++;
            } else {
                f++;
                ft++;
            }
            this.c = c;
            if (this.c >= clan.list.length) {
                this.c = clan.list.length - 1;
            }
            this.clan = clan.list[this.c];
            this.clan.amount++;
            this.age = 0;
            this.maried = 0;
            this.power = this.clan.power;

            this.show = function (i_) {
                if (i_ == sid) {
                    stroke(0);
                } else {
                    noStroke();
                }
                fill(this.clan.color);
                ellipseMode(CORNER);
                rect(this.x, this.y, this.s, this.s);
                textSize(gs / 1.2);
                textAlign(LEFT, TOP);
                strokeWeight(1);
                if (this.gender == M) {
                    stroke(0);
                    fill(0);
                    text(' ♂', this.x, this.y);
                } else {
                    stroke(0);
                    fill(0);
                    text(' ♀', this.x, this.y);
                }
            }
            this.move = function (i, j) {
                this.x += this.s * i;
                this.y += this.s * j;
                this.x = round(this.x / this.s) * this.s;
                this.y = round(this.y / this.s) * this.s;
            }
            this.warp = function (i, j, k, l) {
                if (this.x < i) {
                    this.x = this.x + this.s;
                }
                if (this.y < j) {
                    this.y = this.y + this.s;
                }
                if (this.x > k) {
                    this.x = this.x - this.s;
                }
                if (this.y > l) {
                    this.y = this.y - this.s;
                }
            }

            this.showForce = function (x, y, s) {
                noStroke();
                fill(this.clan.color);
                ellipseMode(CORNER);
                rect(x, y, s, s);
                textSize(s / 1.2);
                textAlign(LEFT, TOP);
                strokeWeight(1);
                if (this.gender == M) {
                    stroke(0);
                    fill(0);
                    text(' ♂', x, y);
                } else {
                    stroke(0);
                    fill(0);
                    text(' ♀', x, y);
                }
            }
        }

        function debug() {
            textSize(ts);
            textAlign(LEFT);
            stroke(0);
            strokeWeight(3);
            fill(0, 200, 255);
            text(M + ' : ' + m, (width / 2) - (wp / 2), wp + (ts * -1));
            fill(255, 150, 200);
            text(F + ' : ' + f, (width / 2) - (wp / 2), wp + (ts * -0.1));
            fill(50);
            stroke(0);
            strokeWeight(1);
            text('YEAR : ' + y, (width / 2) - (wp / 2), wp + (ts * 1));
            text('POPULATION : ' + am, (width / 2) - (wp / 2), wp + (ts * 4));
            text('FRAMERATE : ' + fps + '/' + fr, (width / 2) - (wp / 2), wp + (ts * 3));
            text('GRID : ' + round((q - wp) / gs) + ' × ' + round((q - wp) / gs), (width / 2) - (wp / 2), wp + (ts * 2));
            text('TOTAL POPULATION : ' + tp, (width / 2) - (wp / 2), wp + (ts * 5));
            text('TOTAL DEATHS : ' + (tp - am), (width / 2) - (wp / 2), wp + (ts * 6));
            text('TOTAL CLANS : ' + (clan.list.length), (width / 2) - (wp / 2), wp + (ts * 7));
            var minn = timer / 60;
            var secc = timer % 60;
            text('RUN-TIME : ' + floor(minn) + 'm ' + secc + 's', (width / 2) - (wp / 2), wp + (ts * 8));
            text('TOTAL KILLS : ' + kills, (width / 2) - (wp / 2), wp + (ts * 9));
            text('STARVATION : ' + starv, (width / 2) - (wp / 2), wp + (ts * 10));
            text('SPEED : ' + sp_, (width / 2) - (wp / 2), wp + (ts * 11));
            textAlign(RIGHT, TOP);
            textSize(ds);
            fill(0);
            stroke(0);
            strokeWeight(4);
            for (var i = 0; i < clan.list.length; i++) {
                fill(clan.list[i].color);
                textAlign(RIGHT, TOP);
                textSize(ds);
                strokeWeight(4);
                text(clan.list[i].name + '  ' + clan.list[i].amount, (width / 1.2) - (wp / 2), wp * 1.25 + (ds * (i * 1.5)));
                textAlign(LEFT, TOP);
                textSize(ds / 1.2);
                strokeWeight(3);
                text('POWER = ' + clan.list[i].power, (width / 1.2) - (wp / 2) + ds, wp * 1.25 + (ds * (i * 1.5)));
            }
        }
        var clan = {
            list: [{
                name: 'Unknown', //0
                color: [150, 150, 150],
                power: 2,
                amount: 0,
                array: [],
                enemy: [1],
                friend: [2, 5]
            },
            {
                name: 'Waridoans', //1
                color: [0, 150, 255],
                power: 10,
                amount: 0,
                array: [],
                enemy: [0, 2],
                friend: [3, 6, 7]
            },
            {
                name: 'Illuminatians', //2
                color: [0, 150, 0],
                power: 10,
                amount: 0,
                array: [],
                enemy: [1],
                friend: [0, 5]
            },
            {
                name: 'Emojians', //3
                color: [255, 255, 0],
                power: 6,
                amount: 0,
                array: [],
                enemy: [0],
                friend: [4]
            },
            {
                name: 'Andarisk', //4
                color: [180, 110, 100],
                power: 6,
                amount: 0,
                array: [],
                enemy: [0, 2, 5],
                friend: [3]
            },
            {
                name: 'Ollomonoto', //5
                color: [90, 210, 0],
                power: 14,
                amount: 0,
                array: [],
                enemy: [4],
                friend: [0, 1, 2, 3]
            },
            {
                name: 'Rusch', //6
                color: [150, 0, 255],
                power: 9,
                amount: 0,
                array: [],
                enemy: [2, 5],
                friend: [1, 4]
            },
            {
                name: 'Mordenians', //7
                color: [0, 255, 255],
                power: 13,
                amount: 0,
                array: [],
                enemy: [2, 5],
                friend: [1]
            }
            ]
        }

        function createName() {
            var n = '';
            var nar = [];
            var a1 = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
            var a2 = ['b', 'c', 'd', 'f', 'g', 'h', 'm', 'j', 'k', 'l', 'n', 'p', 'qu', 'r', 's', 't', 'v', 'w', 'z'];
            var a3 = ['a', 'e', 'i', 'o', 'u', 'a', 'e', 'i', 'o', 'u', 'a', 'e', 'i', 'o', 'u', 'y'];
            var comb = ['sch', 'xsk', 'lan', 'sh', 'yex', 'ch'];
            var cbns = round(random(1, 3));
            //var cbns = 0;
            nar[0] = a1[round(random(25))];
            for (var i = 0; i < cbns; i++) {
                nar[nar.length] = a3[round(random(a3.length))];
                var j = round(random(3));
                if (j == 0) {
                    nar[nar.length] = a3[round(random(a3.length))];
                } else if (j == 1 | j == 2) {
                    nar[nar.length] = a2[round(random(a2.length))];
                } else if (j == 3) {
                    nar[nar.length] = comb[round(random(comb.length))];
                }
            }
            n = join(nar, '');
            return n;
        }

        function graph() {
            stroke(0);
            strokeWeight(5);
            fill(220);
            rect(width / 2, height / 2, width / 2.2, height / 2.2);
            push();
            translate(width / 2, height / 2);
            strokeWeight(2);
            noStroke();;
            fill(0, 200, 255);
            beginShape();
            for (var i = 0; i < ma.length; i++) {
                vertex(i * 4, map(round(ma[i] / 10) * 10, 0, maxp, height / 2.2 - 3, 3));
            }
            for (var i = ma.length - 1; i > 0; i--) {
                vertex(i * 4, map(round(ma[i] / 10) * 10, 0, maxp, height / 2.2 - 3, 3) - 4);
            }
            endShape();
            fill(255, 150, 255, 100);
            beginShape();
            for (var i = 0; i < fa.length; i++) {
                vertex(i * 4, map(round(fa[i] / 10) * 10, 0, maxp, height / 2.2 - 3, 3));
            }
            for (var i = fa.length - 1; i > 0; i--) {
                vertex(i * 4, map(round(fa[i] / 10) * 10, 0, maxp, height / 2.2 - 3, 3) - 4);
            }
            endShape();
            noFill();
            strokeWeight(2);
            for (var i = 0; i < clan.list.length; i++) {
                stroke(clan.list[i].color);
                beginShape();
                for (var j = 0; j < clan.list[i].array.length; j++) {
                    vertex(j * 4, map(clan.list[i].array[j], 0, maxp, height / 2.2 - 3, 3));
                }
                endShape();
            }
            pop();
            stroke(0);
            strokeWeight(5);
            noFill();
            rect(width / 2, height / 2, width / 2.2, height / 2.2);
        }

        // function parseGeneralData(JSONData) {
        //     generalSsrResult = split(JSONData.result, ":");
        //     tempResult = generalSsrResult[0];
        //     vibeResult = generalSsrResult[1];
        //     lightResult = generalSsrResult[2];
        // }

        // function handleErrors(Error) {
        //     console.log("There is a error: ", Error);
        // }


    </script>
</body>

</html>